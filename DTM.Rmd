---
title: "DTM"
author: "Abdelrahman Ibrahim"
date: "2023-11-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load DTM Data

```{r}
require(terra)
require(sf)

# Read the first raster to initialize the raster object
dtm_1m <- rast(r"(1_raw_data\dtm_1m.tif)")

# Display the merged raster
plot(dtm_1m)
```

```{r}
# Calculate slope
slope <- terrain(dtm_1m, "slope", neighbors=4, unit = "degrees")
# Calculate aspect
aspect <- terrain(dtm_1m, "aspect", neighbors=4, unit = "degrees")
# Calculate drainage
drainage <- terrain(dtm_1m, "flowdir", neighbors=4, unit = "degrees")

# Optionally, you can plot the results
par(mfrow=c(1,3))
plot(slope, main = "Slope")
plot(aspect, main = "Aspect")
plot(drainage, main = "Drainage")
```

```{r}
# Aggregate the raster to the target resolution (25m)
mm_dtm_25m <- aggregate(dtm_1m, fact = c(25,25))
plot(mm_dtm_25m)
par(mfrow=c(1,2))
plot(dtm_1m, main = "DTM 1 meter (Source)")
plot(mm_dtm_25m, main = "DTM 25 meters (Aggregated)")

writeRaster(mm_dtm_25m, (r"(2_processed_data\mm_dtm_25m.tif)"), overwrite = TRUE)

```



#Resample to the landcover grid

```{r}
landcover_r <- rast(r"(2_processed_data\landcover_MRSDNM.tif)")

# Resample slope
slope_resampled <- resample(slope, landcover_r, "bilinear")
slope_resampled <- terra::crop(slope_resampled, ext(landcover_r))

# Resample aspect
aspect_resampled <- resample(aspect, landcover_r, "bilinear")
aspect_resampled <- terra::crop(aspect_resampled, ext(landcover_r))

# Resample drainage
drainage_resampled <- resample(drainage, landcover_r, "bilinear")
drainage_resampled <- terra::crop(drainage_resampled, ext(landcover_r))

#plot the results
par(mfrow=c(1,3))
plot(slope_resampled, main = "Slope")
plot(aspect_resampled, main = "Aspect")
plot(drainage_resampled, main = "Drainage")

# Save the results
writeRaster(slope_resampled, (r"(2_processed_data\mm_slope_25m_resampled_4.tif)"), overwrite = TRUE)
writeRaster(aspect_resampled, (r"(2_processed_data\mm_aspect_25m_resampled_4.tif)"), overwrite = TRUE)
writeRaster(drainage_resampled, (r"(2_processed_data\mm_drainage_25m_resampled_4.tif)"), overwrite = TRUE)

```




