---
title: "MetOffice DataPoint Parser"
author: "Abdelrahman Ibrahim"
date: "2023-11-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages 

```{r, include=TRUE}
require(httr)
require(jsonlite)
require(sf)
require(tidyverse)
require(purrr)
```

## Get data

measurement stations: 

```{r , include=TRUE}
stations <- readr::read_csv("http://environment.data.gov.uk/flood-monitoring/id/stations.csv", show_col_types = FALSE) %>% 
  filter(parameter == "rainfall")%>%
  filter(stationReference != 'Not_Specified') %>%
  select(stationReference, lat, long)
head(stations)
```

Get the rainfall data:

```{r , include=TRUE}
#Initial call - Do Not Run
base_url <- 'https://environment.data.gov.uk/flood-monitoring/archive/readings-full-'
range <- seq(as.Date("2023/09/01"), as.Date("2023/11/19"), by = "days")
out_url <- apply(expand.grid(base_url, range, ".csv"), 1, paste, collapse = '')

rainfall <- readr::read_csv(out_url, col_select = c("stationReference","parameter", "value","date"), col_types = cols(stationReference = col_character(), date = col_date(), value =col_double())) %>%
  filter(parameter == "rainfall") %>%
  filter(stationReference != 'Not_Specified') %>%
  group_by(date, stationReference) %>%
  summarise(daily_rainfall = sum(value)) %>%
  full_join(stations, by = c("stationReference")) %>%
  drop_na()

head(rainfall)
```


```{r , include=TRUE}
#Append rainfall data to the database
base_url <- 'https://environment.data.gov.uk/flood-monitoring/archive/readings-full-'
range <- seq(as.Date("2023/09/20"), as.Date("2023/11/23"), by = "days")
out_url <- apply(expand.grid(base_url, range, ".csv"), 1, paste, collapse = '')

rainfall <- readr::read_csv(out_url, col_select = c("stationReference","parameter", "value","date"), col_types = cols(stationReference = col_character(), date = col_date(), value =col_double())) %>%
  filter(parameter == "rainfall") %>%
  filter(stationReference != 'Not_Specified') %>%
  group_by(date, stationReference) %>%
  summarise(daily_rainfall = sum(value)) %>%
  full_join(stations, by = c("stationReference")) %>%
  drop_na()

head(rainfall)
```


## Append the daily rainfall database

```{r , include=TRUE}

rainfall_hist <- read.csv((r"(2_processed_data\ea_daily_rainfall.csv)"))
rainfall <- rbind(rainfall_hist, rainfall)
rainfall <-  unique(rainfall)

write.table(rainfall, (r"(2_processed_data\ea_daily_rainfall.csv)"), sep = ",", row.names = FALSE)
```

## Create a surface of daily average observations using IDW interpolation

```{r , include=TRUE}

```

